#!/usr/sbin/nft -f
flush ruleset

define dmz-if = enp7s0f0
define lan-if = enp6s0f1
define wan-if = enp6s0f0
define vm-if = ovsbr0

###### BASIC TABLES AND CHAINS ######

### IPv4 FILTER ###

add table ip filter
add chain ip filter INPUT { type filter hook input priority filter; }
add chain ip filter PREROUTING { type filter hook prerouting priority filter; }
add chain ip filter FORWARD { type filter hook forward priority filter; }
add chain ip filter OUTPUT { type filter hook output priority filter; }

### IPv4 NAT ###

add table ip nat
add chain ip nat PREROUTING { type nat hook prerouting priority dstnat; }
add chain ip nat POSTROUTING { type nat hook postrouting priority srcnat; }

### IPv4 MANGLE ###

add table ip mangle
add chain ip mangle PREROUTING { type filter hook prerouting priority mangle; }
add chain ip mangle INPUT { type filter hook input priority mangle; }
add chain ip mangle FORWARD { type filter hook forward priority mangle; }
add chain ip mangle OUTPUT { type filter hook output priority mangle; }
add chain ip mangle POSTROUTING { type filter hook output priority mangle; }

###### INTERNET OUT FILTER SETS ######

### INTERNET OUT BLOCKED UDP PORTS ###

add set filter internet-out-blocked-udp-ports { type inet_service; flags constant, interval; auto-merge; }
add element ip filter internet-out-blocked-udp-ports {25 comment "SMTP" }
add element ip filter internet-out-blocked-udp-ports {135-139 comment "Microsoft NetBIOS" }
add element ip filter internet-out-blocked-udp-ports {161 comment "SNMP" }
add element ip filter internet-out-blocked-udp-ports {445 comment "Microsoft-DS" }
add element ip filter internet-out-blocked-udp-ports {593 comment "RPC" }
add element ip filter internet-out-blocked-udp-ports {1433-1434 comment "Microsoft SQL" }
add element ip filter internet-out-blocked-udp-ports {1900 comment "Simple Network Discovery Protocol" }

### INTERNET OUT BLOCKED TCP PORTS ###

add set filter internet-out-blocked-tcp-ports { type inet_service; flags constant, interval; auto-merge; }
add element ip filter internet-out-blocked-tcp-ports { 0 comment "IANA Reserved" }
add element ip filter internet-out-blocked-tcp-ports { 25 comment "SMTP" }
add element ip filter internet-out-blocked-tcp-ports { 135-139 comment "Microsoft NetBIOS" }
add element ip filter internet-out-blocked-tcp-ports { 179 comment "Border Gateway Protocol" }
add element ip filter internet-out-blocked-tcp-ports { 445 comment "Microsoft-DS"}
add element ip filter internet-out-blocked-tcp-ports { 593 comment "RPC"}
add element ip filter internet-out-blocked-tcp-ports { 1433-1434 comment "Microsoft SQL" }
add element ip filter internet-out-blocked-tcp-ports { 7547 comment "CPE WAN Management Protocol" }

### RFC 5735 Special Use IPv4 Addresses ###

add set filter special-use-ipv4-addresses { type ipv4_addr; flags constant, interval; auto-merge; }
add element ip filter special-use-ipv4-addresses { 0.0.0.0/8 comment "This network, RFC 1122" }
add element ip filter special-use-ipv4-addresses { 10.0.0.0/8 comment "Private-Use Networks, RFC 1918" } 
add element ip filter special-use-ipv4-addresses { 127.0.0.0/8 comment "Loopback, RFC 1122" }
add element ip filter special-use-ipv4-addresses { 169.254.0.0/16 comment "Private-Use Networks, RFC 1918" }
add element ip filter special-use-ipv4-addresses { 172.16.0.0/12 comment "Private-Use Networks, RFC 1918" }
add element ip filter special-use-ipv4-addresses { 192.0.0.0/24 comment "IETF Protocol Assignments, RFC 5736" }
add element ip filter special-use-ipv4-addresses { 192.0.2.0/24 comment "TEST-NET-1, RFC 5737" }
add element ip filter special-use-ipv4-addresses { 192.168.0.0/16 comment "Private-Use Networks, RFC 1918" }
add element ip filter special-use-ipv4-addresses { 198.18.0.0/15 comment "Network Interconnect Device Benchmark Testing, RFC 1918" }
add element ip filter special-use-ipv4-addresses { 198.51.100.0/24 comment "TEST-NET-2, RFC 5737" }
add element ip filter special-use-ipv4-addresses { 203.0.113.0/24 comment "TEST-NET-3, RFC 5737" }
add element ip filter special-use-ipv4-addresses { 224.0.0.0/4 comment "Multicast, RFC 3171" }
add element ip filter special-use-ipv4-addresses { 240.0.0.0/4 comment "Reserved for Future Use, RFC 1112" }
add element ip filter special-use-ipv4-addresses { 192.88.99.0/24 comment "6to4 Relay Anycast, RFC 3068" }

### RFC 792 ICMP TYPES ###

add set filter blocked-icmp-types { type icmp_type; flags constant, interval; auto-merge; }
add element ip filter blocked-icmp-types { 1 comment "Unassigned" }
add element ip filter blocked-icmp-types { 2 comment "Unassigned" }
add element ip filter blocked-icmp-types { 4 comment "Source Quench (Deprecated)" }
add element ip filter blocked-icmp-types { 6 comment "Alternate Host Address (Deprecated)" }
add element ip filter blocked-icmp-types { 7 comment "Unassigned" }
add element ip filter blocked-icmp-types { 9 comment "Router Advertisement" }
add element ip filter blocked-icmp-types { 10 comment "Router Solicitation" }
add element ip filter blocked-icmp-types { 15 comment "Information Request (Deprecated)" }
add element ip filter blocked-icmp-types { 16 comment "Information Reply (Deprecated)" }
add element ip filter blocked-icmp-types { 17 comment "Address Mask Request (Deprecated)" }
add element ip filter blocked-icmp-types { 18 comment "Address Mask Reply (Deprecated)" }
add element ip filter blocked-icmp-types { 19 comment "Reserved (for Security)" }
add element ip filter blocked-icmp-types { 20-29 comment "Reserved (for Robustness Experiment)" }
add element ip filter blocked-icmp-types { 30 comment "Traceroute (Deprecated)" }
add element ip filter blocked-icmp-types { 31 comment "Datagram Conversion Error (Deprecated)" }
add element ip filter blocked-icmp-types { 32 comment "Mobile Host Redirect (Deprecated)" }
add element ip filter blocked-icmp-types { 33 comment "IPv6 Where-Are-You (Deprecated)" }
add element ip filter blocked-icmp-types { 34 comment "IPv6 I-Am-Here (Deprecated)" }
add element ip filter blocked-icmp-types { 35 comment "Mobile Registration Request (Deprecated)" }
add element ip filter blocked-icmp-types { 36 comment "Mobile Registration Reply (Deprecated)" }
add element ip filter blocked-icmp-types { 37 comment "Domain Name Request (Deprecated)" }
add element ip filter blocked-icmp-types { 38 comment "Domain Name Reply (Deprecated)" }
add element ip filter blocked-icmp-types { 39 comment "SKIP (Deprecated)" }
add element ip filter blocked-icmp-types { 44-252 comment "Unassigned" }
add element ip filter blocked-icmp-types { 253 comment "RFC3692-style Experiment 1" }
add element ip filter blocked-icmp-types { 254 comment "RFC3692-style Experiment 2" }
add element ip filter blocked-icmp-types { 255 comment "Reserved" }

###### CONNTRACK VERDICT MAP FOR EARLY FILTERING ######

add map filter ct_map { type ct_state : verdict; }
add element filter ct_map { established : accept }
add element filter ct_map { related : accept }
add element filter ct_map { invalid : drop }

add ct timeout filter ct_tcp_timeout { protocol tcp; l3proto ip; policy = { established: 7200, time_wait: 60, close_wait: 60 }; }
#add ct timeout filter ct_udp_timeout { protocol udp; l3proto ip; policy = { established: 600 }; }

###### NETFILTER FASTPATH INGRESS HOOK ######

#add flowtable ip filter fastpath { hook ingress priority filter ; devices = { enp6s0f0, enp6s0f1 }; }

###### INCLUDED FILES ######

#include "/etc/fi.zone.nft"


### METER SETS ###

add set ip filter sshconnlimit { type ipv4_addr; flags timeout, dynamic; }
add set ip filter connlimit { type ipv4_addr; flags timeout, dynamic; }

### INPUT-FILTER SETS ###

#add set ip filter inputset { type ifname . inet_proto . inet_service; }

###### FILTER RULES BEGIN HERE ######

### PREROUTING CHAIN ###

add rule ip filter PREROUTING ct state invalid counter drop comment "ANY -> ANY, DROP INVALID CT STATES"
add rule ip filter PREROUTING fib saddr . iif oif missing counter drop comment "ANY -> ANY, DROP PACKETS WITHOUT A REVERSE PATH"
#add rule ip filter PREROUTING iifname $wan-if ct state new add @connlimit { ip saddr ct count over 10000 } drop comment "INTERNET -> CONNLIMIT"

### INPUT FROM DMZ ###

add chain ip filter INPUT-FROM-DMZ

add rule ip filter INPUT-FROM-DMZ udp dport 67 log group 10 counter accept comment "DMZ -> DHCP"
add rule ip filter INPUT-FROM-DMZ udp dport 53 log group 10 counter accept comment "DMZ -> DNS"

### INPUT FROM LAN ###

add chain ip filter INPUT-FROM-LAN

add rule ip filter INPUT-FROM-LAN udp dport 67 log group 10 counter accept comment "LAN -> DHCP"
add rule ip filter INPUT-FROM-LAN udp dport 53 log group 10 counter accept comment "LAN -> DNS"
add rule ip filter INPUT-FROM-LAN tcp dport 445 log group 10 counter accept comment "LAN -> SAMBA"
add rule ip filter INPUT-FROM-LAN tcp dport 64738 log group 10 counter accept comment "LAN -> INPUT MUMBLE-SERVER TCP // DATA"
add rule ip filter INPUT-FROM-LAN udp dport 64738 log group 10 counter accept comment "LAN -> INPUT MUMBLE-SERVER UDP // VOICE"
add rule ip filter INPUT-FROM-LAN udp dport 1200 log group 10 counter accept comment "LAN -> INPUT REX-SERVER // UDP"
add rule ip filter INPUT-FROM-LAN udp dport 1223 log group 10 counter accept comment "LAN -> INPUT REX-WG // UDP"
add rule ip filter INPUT-FROM-LAN tcp dport {80,443} log group 10 counter accept comment "LAN -> INPUT NGINX-PROXY // HTTP, HTTPS"
add rule ip filter INPUT-FROM-LAN tcp dport 22 log group 10 counter accept comment "LAN -> INPUT SSH"
add rule ip filter INPUT-FROM-LAN log group 11 counter drop comment "LAN -> INPUT POLICY DROP"

### INPUT-FROM-INTERNET ###

add chain ip filter INPUT-FROM-INTERNET

add rule ip filter INPUT-FROM-INTERNET tcp dport {80,443} log group 10 counter accept comment "INTERNET -> NGINX-PROXY // HTTP, HTTPS"
add rule ip filter INPUT-FROM-INTERNET tcp dport 64738 log group 10 counter accept comment "INTERNET -> INPUT MUMBLE-SERVER TCP // DATA"
add rule ip filter INPUT-FROM-INTERNET udp dport 64738 log group 10 counter accept comment "INTERNET -> INPUT MUMBLE-SERVER UDP // VOICE"
add rule ip filter INPUT-FROM-INTERNET udp dport 1200 log group 10 counter accept comment "INTERNET -> INPUT OPENVPN REX-SERVER // UDP"
add rule ip filter INPUT-FROM-INTERNET udp dport 1201 log group 10 counter accept comment "INTERNET -> INPUT OPENVPN MEI-SERVER // UDP"
add rule ip filter INPUT-FROM-INTERNET udp dport 1203 log group 10 counter accept comment "INTERNET -> INPUT OPENVPN A44-SERVER // UDP"
add rule ip filter INPUT-FROM-INTERNET udp dport 1223 log group 10 counter accept comment "INTERNET -> INPUT WIREGUARD REX-WG // UDP"
add rule ip filter INPUT-FROM-INTERNET log group 11 counter drop comment "INTERNET -> INPUT POLICY DROP"

### INPUT-FROM-VPN ###

add chain ip filter INPUT-FROM-VPN

add rule ip filter INPUT-FROM-VPN tcp dport 22 log group 10 counter accept comment "VPN-ZONE -> INPUT SSH"
add rule ip filter INPUT-FROM-VPN tcp dport 445 log group 10 counter accept comment "VPN -> INPUT SAMBA"
add rule ip filter INPUT-FROM-VPN log group 11 counter drop comment "VPN -> INPUT POLICY DROP"

### INPUT CHAIN ###

add rule ip filter INPUT iif lo accept comment "LOOPBACK"
add rule ip filter INPUT ct state established, related counter accept comment "ESTABLISHED AND RELATED CONNECTIONS"
add rule ip filter INPUT ct timeout set "ct_tcp_timeout" comment "CUSTOM TCP TIMEOUTS"
add rule ip filter INPUT icmp type != @blocked-icmp-types counter accept comment "ICMP"
add rule ip filter INPUT iifname $wan-if ct state new counter jump INPUT-FROM-INTERNET comment "INPUT INTERNET-ZONE"
add rule ip filter INPUT iifname $lan-if ct state new counter jump INPUT-FROM-LAN comment "INPUT LAN-ZONE"
add rule ip filter INPUT iifname $dmz-if ct state new counter jump INPUT-FROM-DMZ comment "INPUT DMZ-ZONE"
add rule ip filter INPUT iifname {"rex0","mei0","rex-wg"} ct state new counter jump INPUT-FROM-VPN comment "INPUT VPN-ZONE"
add rule ip filter INPUT iifname $vm-if ip saddr 10.0.100.7 udp dport 161 log group 10 counter accept comment "VMNET -> SNMP"
add rule ip filter INPUT log group 11 counter drop comment "POLICY DROP INPUT"

### OUTPUT FILTER ###

add rule ip filter OUTPUT ct timeout set "ct_tcp_timeout" comment "CUSTOM CT TIMEOUTS FOR TCP"
add rule ip filter OUTPUT oifname $wan-if tcp dport @internet-out-blocked-tcp-ports log group 21 counter drop comment "HOST -> INTERNET TCP DROP FILTER"
add rule ip filter OUTPUT oifname $wan-if udp dport @internet-out-blocked-udp-ports log group 21 counter drop comment "HOST -> INTERNET UDP DROP FILTER"
add rule ip filter OUTPUT oifname $wan-if ip daddr @special-use-ipv4-addresses log group 21 counter drop comment "HOST -> INTERNET RFC-5735 FILTER"
add rule ip filter OUTPUT log group 20 counter accept comment "POLICY ACCEPT OUTPUT"

### FORWARD FILTER ###

#add rule ip filter FORWARD ct state established iif $wan-if oif $lan-if counter flow offload @fastpath comment "LAN <-> INTERNET FASTPATH TEST 02092019"
add rule ip filter FORWARD ct state established, related counter accept comment "ANY -> ANY, ESTABLISHED, RELATED"
add rule ip filter FORWARD ct timeout set "ct_tcp_timeout" comment "TEST: CUSTOM CT TIMEOUTS FOR TCP"
add rule ip filter FORWARD oifname $wan-if tcp dport @internet-out-blocked-tcp-ports log group 31 counter drop comment "ANY -> INTERNET TCP DROP FILTER"
add rule ip filter FORWARD oifname $wan-if udp dport @internet-out-blocked-udp-ports log group 31 counter drop comment "ANY -> INTERNET UDP DROP FILTER"
add rule ip filter FORWARD oifname $wan-if ip daddr @special-use-ipv4-addresses log group 31 counter drop comment "ANY -> INTERNET RFC-5735 DROP FILTER"
add rule ip filter FORWARD oifname $wan-if icmp type @blocked-icmp-types counter log group 31 counter drop comment "ANY -> INTERNET, ESTETYT ICMP"
add rule ip filter FORWARD iifname $lan-if oifname $wan-if log group 30 counter accept comment "LAN -> INTERNET ANY"
add rule ip filter FORWARD iifname $dmz-if oifname $wan-if log group 30 counter accept comment "DMZ -> INTERNET ANY"
add rule ip filter FORWARD iifname $lan-if oifname $vm-if log group 30 counter accept comment "LAN -> VMNET ANY"
add rule ip filter FORWARD iifname $lan-if oifname {"a44-vpn","rex0","mei0","rex-wg"} log group 30 counter accept comment "LAN -> VPN ANY"
add rule ip filter FORWARD iifname $wan-if oifname $vm-if ip daddr 10.0.100.2 tcp dport 22 log group 30 counter accept comment "INTERNET -> VMNET, DEKO1 SSH"
add rule ip filter FORWARD iifname $wan-if oifname $vm-if ip daddr 10.0.100.2 udp dport {27992,27982} log group 30 counter accept comment "INTERNET -> VMNET, DEKO1 DAIKATANA"
add rule ip filter FORWARD iifname $wan-if oifname $vm-if ip daddr 10.0.100.2 tcp dport 27992 log group 30 counter accept comment "INTERNET -> VMNET, DEKO1 DAIKATANA"
add rule ip filter FORWARD iifname $vm-if oifname $wan-if log group 30 counter accept comment "VMNET -> INTERNET ANY"
add rule ip filter FORWARD iifname $vm-if ip saddr 10.0.100.7 oifname rex0 icmp type != @blocked-icmp-types log group 30 counter accept comment "VMNET VALVONTA -> REXVPN, ICMP"
add rule ip filter FORWARD iifname $vm-if ip saddr 10.0.100.7 oifname rex0 udp dport 161 log group 30 counter accept comment "VMNET VALVONTA -> REXVPN, SNMP"
add rule ip filter FORWARD iifname $vm-if ip saddr 10.0.100.7 oifname a44-vpn log group 30 counter accept comment "VMNET VALVONTA -> A44 ANY"
add rule ip filter FORWARD iifname rex0 oifname rex0 log group 30 counter counter accept comment "REXVPN <-> REXVPN ANY"
#add rule ip filter FORWARD iifname rex-wg oifname rex-wg log group 30 counter counter accept comment "REX-WG <-> REX-WG ANY"
add rule ip filter FORWARD iifname rex-wg ip saddr 10.23.200.10 oifname $wan-if log group 30 counter counter accept comment "REX-WG S8 <-> INTERNET"
add rule ip filter FORWARD iifname $wan-if oifname $lan-if ip daddr 10.23.10.10 tcp dport 7001 log group 30 counter counter accept comment "INTERNET <-> BITTORRENT"
add rule ip filter FORWARD iifname $wan-if oifname $lan-if ip daddr 10.23.10.10 udp dport 7001 log group 30 counter counter accept comment "INTERNET <-> BITTORRENT"
add rule ip filter FORWARD log group 31 counter drop comment "POLICY DROP FORWARD"

###### NAT RULES BEGIN HERE ######

## Source NAT ##

add rule ip nat POSTROUTING ip saddr 10.23.10.0/24 oifname $wan-if counter masquerade random, persistent comment "LAN-ZONE -> INTERNET SNAT"
add rule ip nat POSTROUTING ip saddr 10.23.210.0/24 oifname $wan-if counter masquerade random, persistent comment "DMZ-ZONE -> INTERNET SNAT"
add rule ip nat POSTROUTING ip saddr 10.0.100.0/24 oifname $wan-if counter masquerade random, persistent comment "VMNET-ZONE -> INTERNET SNAT"
add rule ip nat POSTROUTING ip saddr 10.23.200.1/24 oifname $wan-if counter masquerade random, persistent comment "REX-WG-VPN -> INTERNET SNAT"

#add rule ip nat POSTROUTING oifname $wan-if counter masquerade random comment "ANY -> INTERNET SNAT"
#add rule ip nat POSTROUTING ip saddr 10.23.200.10 oifname $wan-if counter masquerade random comment "REX-WG -> INTERNET SNAT"
add rule ip nat POSTROUTING oifname {"rex0","mei0","a44-vpn","rex-wg"} counter masquerade random comment "ANY -> VPN SNAT"

## Destination NAT ##

add rule ip nat PREROUTING iifname $wan-if tcp dport 7001 dnat 10.23.10.10 comment "BitTorrent"
add rule ip nat PREROUTING iifname $wan-if udp dport 7001 dnat 10.23.10.10 comment "BitTorrent"
add rule ip nat PREROUTING iifname $wan-if tcp dport 27992 counter dnat 10.0.100.2 comment "INTERNET -> DEKO1 DNAT, DAIKATANA"
add rule ip nat PREROUTING iifname $wan-if udp dport {27982,27992} counter dnat 10.0.100.2 comment "INTERNET -> DEKO1 DNAT, DAIKATANA"
add rule ip nat PREROUTING iifname $wan-if tcp dport 1222 counter dnat 10.0.100.2:22 comment "INTERNET -> DEKO1 DNAT, SSH"

###### MANGLE RULES BEGIN HERE ######

#add rule ip mangle PREROUTING iifname rex0 tcp flags syn tcp option maxseg size set 1432 counter comment "MSSFIX REX0" 
#add rule ip mangle POSTROUTING oif $wan-if udp sport {27015,27025,27047,64738} meta priority set 1:2
#add rule ip mangle POSTROUTING oif $wan-if tcp sport {22,80,443} counter meta priority set 1:2

